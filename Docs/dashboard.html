<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call of Productivity - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <style>
        /* ESTILOS ADICIONALES PARA FIREBASE */
        .user-profile {
            position: relative;
            cursor: pointer;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(1, 226, 121, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(1, 226, 121, 0.3);
            color: #01e279;
        }
        
        .user-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-width: 200px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            margin-top: 5px;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            color: var(--text-color);
            text-decoration: none;
            transition: background 0.3s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }
        
        .dropdown-item:hover {
            background: rgba(1, 226, 121, 0.1);
        }
        
        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 5px 0;
        }
        
        .logout-btn {
            color: #e74c3c;
        }
        
        .logout-btn:hover {
            background: rgba(231, 76, 60, 0.1);
        }
        
        .user-stats-section {
            margin: 30px 0;
        }
        
        .user-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .user-stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-stat-card.verified {
            border-color: #01e279;
            background: rgba(1, 226, 121, 0.05);
        }
        
        .user-stat-card.not-verified {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.05);
        }
        
        .user-stat-icon {
            font-size: 2rem;
            color: #01e279;
        }
        
        .user-stat-card.not-verified .user-stat-icon {
            color: #f39c12;
        }
        
        .user-stat-content h3 {
            margin: 0 0 5px 0;
            color: var(--text-color);
        }
        
        .user-stat-content p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-badge.verified {
            background: #01e279;
            color: #000;
        }
        
        .status-badge.not-verified {
            background: #f39c12;
            color: #000;
        }
        
        .resend-btn {
            margin-top: 10px;
            padding: 5px 10px;
            background: rgba(1, 226, 121, 0.1);
            border: 1px solid #01e279;
            color: #01e279;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .resend-btn:hover {
            background: rgba(1, 226, 121, 0.2);
        }
        
        .footer-user {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .firebase-status-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
        }
        
        /* Estilo para loading */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0A0A0A;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(1, 226, 121, 0.3);
            border-radius: 50%;
            border-top-color: #01e279;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #01e279;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 2px;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-wrap: wrap;
            }
            
            .user-profile {
                order: 3;
                width: 100%;
                margin-top: 15px;
            }
            
            .user-dropdown {
                right: auto;
                left: 0;
                width: 100%;
            }
            
            .user-stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- PANTALLA DE CARGA -->
    <div id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">CARGANDO SISTEMA TÁCTICO</div>
        <div id="loadingStatus" style="margin-top: 10px; color: #888; font-size: 0.9rem;"></div>
    </div>

    <!-- FONDO DINÁMICO -->
    <div class="background-overlay dashboard-bg" id="backgroundOverlay"></div>

    <!-- CONTENEDOR PRINCIPAL (OCULTO INICIALMENTE) -->
    <div class="dashboard-container" style="display: none;">
        <!-- HEADER -->
        <header>
            <div class="header-content">
                <div class="logo-container" id="logoHome">
                    <div class="logo">COP</div>
                    <div class="logo-text">CALL OF PRODUCTIVITY</div>
                </div>
                <nav class="nav-menu">
                    <a href="dashboard.html" class="nav-link active">Dashboard</a>
                    <a href="missions.html" class="nav-link">Misiones</a>
                    <a href="profile.html" class="nav-link">Perfil</a>
                    <a href="Logros.html" class="nav-link">Logros</a>
                </nav>
                <div class="user-profile" id="userProfile">
                    <div class="user-info" id="userInfo">
                        <i class="fas fa-user-circle"></i>
                        <span id="userEmail">Cargando...</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-item" id="userDetails">
                            <i class="fas fa-user"></i>
                            <span id="userName">Usuario</span>
                        </div>
                        <div class="dropdown-item" id="userStats">
                            <i class="fas fa-chart-line"></i>
                            <span>Nivel <span id="userLevel">1</span></span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="profile.html" class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            <span>Configuración</span>
                        </a>
                        <button class="dropdown-item logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Cerrar Sesión</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- PÁGINA: DASHBOARD -->
        <section class="page active" id="dashboard-page">
            <!-- HERO SECTION -->
            <section class="hero-section">
                <h1>CALL OF PRODUCTIVITY</h1>
                <p class="hero-subtitle" id="welcomeMessage">Convierte tus tareas en misiones. Aumenta tu nivel, completa objetivos y domina tu día a día como un operador de élite.</p>
                <button class="btn-primary" id="startMissionBtn">
                    <i class="fas fa-play-circle"></i> INICIAR MISIÓN
                </button>
            </section>

            <!-- USER STATS SECTION -->
            <section class="user-stats-section" id="userStatsSection">
                <h2>TU ESTADO DE OPERADOR</h2>
                <div class="user-stats-grid">
                    <div class="user-stat-card verified" id="emailVerifiedCard">
                        <div class="user-stat-icon">
                            <i class="fas fa-shield-check"></i>
                        </div>
                        <div class="user-stat-content">
                            <h3>Cuenta Verificada</h3>
                            <p id="emailStatus">Estado del email: <span class="status-badge verified">Verificado</span></p>
                        </div>
                    </div>
                    <div class="user-stat-card">
                        <div class="user-stat-icon">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div class="user-stat-content">
                            <h3>Miembro desde</h3>
                            <p id="memberSince">Cargando fecha...</p>
                        </div>
                    </div>
                    <div class="user-stat-card">
                        <div class="user-stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="user-stat-content">
                            <h3>Último Acceso</h3>
                            <p id="lastLogin">Hace unos momentos</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- STATS SECTION -->
            <section class="stats-section">
                <h2>ESTADÍSTICAS DEL OPERADOR</h2>
                <div class="stats-grid">
                    <!-- XP ACTUAL -->
                    <div class="stat-card">
                        <div class="stat-title">XP Actual</div>
                        <div class="stat-value" id="currentXP">8,450</div>
                        <div class="stat-details">+350 XP esta semana</div>
                    </div>

                    <!-- RANGO -->
                    <div class="stat-card">
                        <div class="stat-title">Rango del Operador</div>
                        <div class="rank-display">
                            <div class="rank-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div>
                                <div class="stat-value" id="currentRank">Capitán</div>
                                <div class="stat-details" id="currentLevel">Nivel 24</div>
                            </div>
                        </div>
                    </div>

                    <!-- MISIONES ACTIVAS -->
                    <div class="stat-card">
                        <div class="stat-title">Misiones Activas</div>
                        <div class="stat-value" id="activeMissions">3/5</div>
                        <div class="stat-details" id="pendingMissions">2 misiones pendientes</div>
                    </div>

                    <!-- RACHA DIARIA -->
                    <div class="stat-card">
                        <div class="stat-title">Racha Diaria</div>
                        <div class="stat-value" id="dailyStreak">14 días</div>
                        <div class="stat-details" id="bestStreak">Mejor racha: 21 días</div>
                    </div>
                </div>
            </section>

            <!-- MISSIONS SECTION -->
            <section class="missions-section">
                <h2>MISIONES ACTIVAS</h2>
                <div class="missions-grid">
                    <!-- MISIÓN 1 -->
                    <div class="mission-card">
                        <div class="mission-header">
                            <h3 class="mission-title">Informe Trimestral</h3>
                            <span class="mission-category">Trabajo</span>
                        </div>
                        <div class="mission-progress">
                            <div class="progress-info">
                                <span>Progreso</span>
                                <span>65%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" data-width="65"></div>
                            </div>
                        </div>
                        <div class="mission-footer">
                            <div class="mission-xp">
                                <i class="fas fa-bolt"></i> 500 XP
                            </div>
                            <button class="btn-complete">Completar</button>
                        </div>
                    </div>

                    <!-- MISIÓN 2 -->
                    <div class="mission-card">
                        <div class="mission-header">
                            <h3 class="mission-title">Entrenamiento Físico</h3>
                            <span class="mission-category">Salud</span>
                        </div>
                        <div class="mission-progress">
                            <div class="progress-info">
                                <span>Progreso</span>
                                <span>30%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" data-width="30"></div>
                            </div>
                        </div>
                        <div class="mission-footer">
                            <div class="mission-xp">
                                <i class="fas fa-bolt"></i> 300 XP
                            </div>
                            <button class="btn-complete">Completar</button>
                        </div>
                    </div>

                    <!-- MISIÓN 3 -->
                    <div class="mission-card">
                        <div class="mission-header">
                            <h3 class="mission-title">Curso Online</h3>
                            <span class="mission-category">Aprendizaje</span>
                        </div>
                        <div class="mission-progress">
                            <div class="progress-info">
                                <span>Progreso</span>
                                <span>80%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" data-width="80"></div>
                            </div>
                        </div>
                        <div class="mission-footer">
                            <div class="mission-xp">
                                <i class="fas fa-bolt"></i> 750 XP
                            </div>
                            <button class="btn-complete">Completar</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- FIREBASE STATUS -->
            <section class="firebase-status-section" style="margin-top: 40px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 10px;">
                <h3><i class="fas fa-database"></i> Estado de Firebase</h3>
                <div id="firebaseStatus" style="margin-top: 10px; color: #01e279;">
                    ✅ Conexión establecida correctamente
                </div>
            </section>
        </section>

        <!-- FOOTER -->
        <footer>
            <p>CALL OF PRODUCTIVITY © 2026 | Sistema de productividad táctico | Todos los derechos reservados</p>
            <p class="footer-user" id="footerUserInfo">Usuario: <span id="footerUserEmail">Cargando...</span></p>
        </footer>
    </div>

    <!-- SCRIPTS -->
    <script src="js/dashboard.js"></script>
    <script src="js/theme-system.js"></script>
    
    <script>
        // ============================================
        // CONFIGURACIÓN DE FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyA84yn9sEpKXC9CkLSpXSFWChphQivyjQA",
            authDomain: "call-of-duty-ba8c6.firebaseapp.com",
            projectId: "call-of-duty-ba8c6",
            storageBucket: "call-of-duty-ba8c6.firebasestorage.app",
            messagingSenderId: "332396788517",
            appId: "1:332396788517:web:9b16dba369dda189dd78cc",
            measurementId: "G-X7SKWF7J9X"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // ============================================
        // FUNCIONES DE AUTENTICACIÓN - CORREGIDAS
        // ============================================
        
        // Actualizar estado de carga
        function updateLoadingStatus(message) {
            const statusElement = document.getElementById('loadingStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
            console.log('Loading:', message);
        }

        // Mostrar contenido principal
        function showMainContent() {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContent = document.querySelector('.dashboard-container');
            
            // Ocultar pantalla de carga
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                // Mostrar contenido principal
                mainContent.style.display = 'block';
                // Animar entrada
                mainContent.style.opacity = '0';
                mainContent.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    mainContent.style.transition = 'opacity 0.5s, transform 0.5s';
                    mainContent.style.opacity = '1';
                    mainContent.style.transform = 'translateY(0)';
                }, 100);
            }, 300);
        }

        // Verificar autenticación sin redirección automática
        function checkAuth() {
            updateLoadingStatus('Verificando autenticación...');
            
            return new Promise((resolve, reject) => {
                // Primero verificar localStorage
                const userData = localStorage.getItem('user');
                const storedUser = userData ? JSON.parse(userData) : null;
                
                // Luego verificar Firebase
                const currentUser = auth.currentUser;
                
                if (currentUser || storedUser) {
                    // Hay usuario, continuar
                    resolve(currentUser || storedUser);
                } else {
                    // No hay usuario, pero esperar a que Firebase se inicialice
                    updateLoadingStatus('Esperando respuesta de Firebase...');
                    
                    const unsubscribe = auth.onAuthStateChanged((user) => {
                        unsubscribe(); // Dejar de escuchar después del primer cambio
                        
                        if (user) {
                            resolve(user);
                        } else {
                            // Solo redirigir después de 3 segundos si realmente no hay usuario
                            updateLoadingStatus('No hay sesión activa. Redirigiendo...');
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 3000);
                            reject(new Error('No autenticado'));
                        }
                    });
                    
                    // Timeout por si Firebase tarda demasiado
                    setTimeout(() => {
                        unsubscribe();
                        if (storedUser) {
                            resolve(storedUser); // Usar datos almacenados
                        } else {
                            updateLoadingStatus('Redirigiendo al login...');
                            window.location.href = 'index.html';
                            reject(new Error('Timeout en autenticación'));
                        }
                    }, 5000);
                }
            });
        }

        // Formatear fecha
        function formatDate(timestamp) {
            if (!timestamp) return 'Fecha no disponible';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Formatear tiempo relativo
        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Hace un momento';
            
            const now = new Date();
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Hace unos momentos';
            if (diffMins < 60) return `Hace ${diffMins} minuto${diffMins !== 1 ? 's' : ''}`;
            if (diffHours < 24) return `Hace ${diffHours} hora${diffHours !== 1 ? 's' : ''}`;
            if (diffDays < 7) return `Hace ${diffDays} día${diffDays !== 1 ? 's' : ''}`;
            
            return formatDate(timestamp);
        }

        // Actualizar información del usuario
        function updateUserInfo(user) {
            updateLoadingStatus('Cargando información del usuario...');
            
            // Actualizar header
            document.getElementById('userEmail').textContent = user.email || 'Usuario';
            document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
            
            // Actualizar mensaje de bienvenida
            const welcomeMessage = document.getElementById('welcomeMessage');
            const name = user.displayName || user.email.split('@')[0];
            welcomeMessage.textContent = `Bienvenido de nuevo, Operador ${name}. Convierte tus tareas en misiones y domina tu día a día.`;
            
            // Actualizar estado del email
            const emailStatus = document.getElementById('emailStatus');
            const emailVerifiedCard = document.getElementById('emailVerifiedCard');
            
            if (user.emailVerified) {
                emailStatus.innerHTML = 'Estado del email: <span class="status-badge verified">Verificado</span>';
                emailVerifiedCard.classList.add('verified');
                emailVerifiedCard.classList.remove('not-verified');
            } else {
                emailStatus.innerHTML = 'Estado del email: <span class="status-badge not-verified">No verificado</span>';
                emailVerifiedCard.classList.remove('verified');
                emailVerifiedCard.classList.add('not-verified');
                
                // Agregar botón para reenviar verificación
                if (!document.getElementById('resendVerificationBtn')) {
                    const resendBtn = document.createElement('button');
                    resendBtn.id = 'resendVerificationBtn';
                    resendBtn.className = 'resend-btn';
                    resendBtn.innerHTML = '<i class="fas fa-redo"></i> Reenviar verificación';
                    resendBtn.addEventListener('click', () => {
                        auth.currentUser.sendEmailVerification().then(() => {
                            alert('✅ Email de verificación enviado. Revisa tu bandeja de entrada.');
                        }).catch(error => {
                            alert('❌ Error al enviar el email: ' + error.message);
                        });
                    });
                    emailStatus.parentElement.appendChild(resendBtn);
                }
            }
            
            // Actualizar fecha de creación
            const memberSince = document.getElementById('memberSince');
            if (user.metadata && user.metadata.creationTime) {
                memberSince.textContent = formatDate(new Date(user.metadata.creationTime));
            } else {
                memberSince.textContent = 'Hoy';
            }
            
            // Actualizar último acceso
            const lastLogin = document.getElementById('lastLogin');
            if (user.metadata && user.metadata.lastSignInTime) {
                lastLogin.textContent = formatTimeAgo(new Date(user.metadata.lastSignInTime));
            }
            
            // Actualizar footer
            document.getElementById('footerUserEmail').textContent = user.email;
            
            // Actualizar nivel basado en email (ejemplo simple)
            const level = user.emailVerified ? 24 : 1;
            document.getElementById('userLevel').textContent = level;
            
            // Guardar en localStorage para persistencia
            localStorage.setItem('user', JSON.stringify({
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL,
                uid: user.uid,
                emailVerified: user.emailVerified,
                metadata: user.metadata
            }));
        }

        // Cerrar sesión
        function logout() {
            updateLoadingStatus('Cerrando sesión...');
            
            auth.signOut().then(() => {
                // Limpiar localStorage
                localStorage.removeItem('user');
                
                // Redirigir al login
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Error al cerrar sesión:', error);
                // Redirigir de todas formas
                localStorage.removeItem('user');
                window.location.href = 'index.html';
            });
        }

        // ============================================
        // INICIALIZACIÓN PRINCIPAL
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            updateLoadingStatus('Iniciando sistema...');
            
            try {
                // Esperar a que Firebase se inicialice
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Verificar autenticación
                const user = await checkAuth();
                
                if (user) {
                    updateLoadingStatus('Sesión activa detectada. Cargando dashboard...');
                    
                    // Actualizar información del usuario
                    updateUserInfo(user);
                    
                    // Mostrar contenido principal después de un breve delay
                    setTimeout(() => {
                        showMainContent();
                        initDashboardFunctions();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error en inicialización:', error);
                updateLoadingStatus('Error al cargar. Redirigiendo...');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        });

        // Inicializar funciones del dashboard
        function initDashboardFunctions() {
            updateLoadingStatus('Inicializando funciones...');
            
            // Animar barras de progreso
            const progressBars = document.querySelectorAll('.progress-fill');
            progressBars.forEach(bar => {
                const width = bar.getAttribute('data-width');
                setTimeout(() => {
                    bar.style.width = width + '%';
                }, 300);
            });

            // Botón "Iniciar Misión"
            const startMissionBtn = document.getElementById('startMissionBtn');
            if (startMissionBtn) {
                startMissionBtn.addEventListener('click', function() {
                    // Animación de clic
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);

                    // Simular inicio de misión
                    alert('¡MISIÓN INICIADA! \n\nNueva misión añadida: "Revisar Dashboard COP" \nRecompensa: 150 XP');
                    
                    // Actualizar estadísticas
                    const currentXP = document.getElementById('currentXP');
                    let xp = parseInt(currentXP.textContent.replace(',', '')) || 0;
                    xp += 150;
                    currentXP.textContent = xp.toLocaleString();
                });
            }

            // Botones "Completar" misión
            const completeButtons = document.querySelectorAll('.btn-complete');
            completeButtons.forEach((button, index) => {
                button.addEventListener('click', function() {
                    const missionCard = this.closest('.mission-card');
                    const missionTitle = missionCard.querySelector('.mission-title').textContent;
                    const missionXP = missionCard.querySelector('.mission-xp').textContent;
                    
                    // Animación de clic
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);

                    // Cambiar estado del botón
                    this.textContent = 'COMPLETADO';
                    this.style.backgroundColor = '#2ecc71';
                    this.style.borderColor = '#2ecc71';
                    this.disabled = true;

                    // Actualizar XP
                    const currentXP = document.getElementById('currentXP');
                    let xp = parseInt(currentXP.textContent.replace(',', '')) || 0;
                    const xpGained = parseInt(missionXP.match(/\d+/)[0]) || 0;
                    xp += xpGained;
                    currentXP.textContent = xp.toLocaleString();

                    // Actualizar misiones activas
                    const activeMissions = document.getElementById('activeMissions');
                    const [current, total] = activeMissions.textContent.split('/').map(n => parseInt(n) || 0);
                    if (current > 0) {
                        activeMissions.textContent = `${current - 1}/${total}`;
                    }

                    // Mostrar notificación
                    alert(`¡MISIÓN COMPLETADA! \n\n${missionTitle} \nRecompensa obtenida: ${missionXP}`);
                });
            });

            // Botón de cerrar sesión
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // Menú desplegable del usuario
            const userProfile = document.getElementById('userProfile');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userProfile && userDropdown) {
                userProfile.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
                });

                // Cerrar menú al hacer clic fuera
                document.addEventListener('click', function() {
                    userDropdown.style.display = 'none';
                });
            }

            // Configurar listener para cambios de autenticación
            auth.onAuthStateChanged((firebaseUser) => {
                if (firebaseUser) {
                    updateUserInfo(firebaseUser);
                } else {
                    // Si se cierra sesión en otra pestaña, mostrar advertencia
                    console.log('Sesión cerrada en otra pestaña');
                    
                    // Mostrar mensaje de advertencia
                    const statusElement = document.getElementById('firebaseStatus');
                    if (statusElement) {
                        statusElement.innerHTML = '⚠️ Sesión cerrada. Redirigiendo en 5 segundos...';
                        statusElement.style.color = '#f39c12';
                    }
                    
                    // Redirigir después de 5 segundos
                    setTimeout(() => {
                        localStorage.removeItem('user');
                        window.location.href = 'index.html';
                    }, 5000);
                }
            });

            updateLoadingStatus('Dashboard cargado correctamente');
            console.log('✅ Dashboard con Firebase cargado correctamente');
        }

        // Script de inicialización rápida (temas)
        document.documentElement.style.visibility = 'hidden';
        document.documentElement.style.opacity = '0';

        window.addEventListener('DOMContentLoaded', () => {
            // Aplicar tema guardado inmediatamente
            const savedTheme = localStorage.getItem('cop_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Mostrar contenido
            setTimeout(() => {
                document.documentElement.style.visibility = '';
                document.documentElement.style.opacity = '1';
            }, 10);
            
            // Cargar el sistema de temas
            if (typeof initThemeSystem === 'function') {
                initThemeSystem();
            }
        });

        // Fallback si hay error
        setTimeout(() => {
            if (document.documentElement.style.visibility === 'hidden') {
                document.documentElement.style.visibility = '';
                document.documentElement.style.opacity = '1';
            }
        }, 1000);
    </script>
</body>
</html>